# Environment variables
#  AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY - AWS credentials
#  AWS_ACCOUNT_ID - id used to login to AWS
#  AWS_DEFAULT_REGION - which region to login to (where ECR is located)
#  DOCKER_IMAGE_NAME - the name of the image built by sbt
#  ECS_CLUSTER_NAME - the name of the cluster in ECS to deploy to
#  ECS_SERVICE_NAME - the name of the service in ECS to deploy to

function require {
  if [ -z "$2" ]; then
    echo "$1 "
  fi
}

deploy_cluster() {

    ./project/ecs-deploy -c $ECS_CLUSTER_NAME -t 256 -n $ECS_SERVICE_NAME \
        -i $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$DOCKER_IMAGE_NAME:1.0-${CIRCLE_SHA1:0:16}

}

manifest_properties() {

  # Created date
  echo -n "date="
  date -u +"%Y-%m-%dT%H:%M:%SZ"

  # Who built it
  echo -n "user="
  id --user --name

  # Where it was built
  echo -n "hostname="
  hostname --short
  echo -n "ips="
  hostname --ip-address

  # Git details
  echo -n "gitUrl="
  git config --get remote.origin.url
  echo -n "gitBranch="
  git rev-parse --abbrev-ref HEAD
  echo -n "gitHash="
  git rev-parse HEAD
}

push_ecr_image(){
	eval $(aws ecr get-login)
	manifest_properties > manifest_properties.txt
	sbt docker:publish
	echo "{\"docker-image\": \"$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$DOCKER_IMAGE_NAME:1.0-"${CIRCLE_SHA1:0:16}"\"}" > $CIRCLE_ARTIFACTS/docker-image.json
}

MISSING=''
MISSING+=$(require 'AWS_ACCESS_KEY_ID' "$AWS_ACCESS_KEY_ID")
MISSING+=$(require 'AWS_SECRET_ACCESS_KEY' "$AWS_SECRET_ACCESS_KEY")
MISSING+=$(require 'AWS_ACCOUNT_ID' "$AWS_ACCOUNT_ID")
MISSING+=$(require 'AWS_DEFAULT_REGION' "$AWS_DEFAULT_REGION")
MISSING+=$(require 'DOCKER_IMAGE_NAME' "$DOCKER_IMAGE_NAME")
MISSING+=$(require 'ECS_CLUSTER_NAME' "$ECS_CLUSTER_NAME")
MISSING+=$(require 'ECS_SERVICE_NAME' "$ECS_SERVICE_NAME")

if [ ! -z "$MISSING" ]; then
  echo "Missing environment variables: $MISSING"
  exit 2
fi
